<!DOCTYPE html>
<html>
<head>
    <title>MIDI Helper</title>
    <style>
        body { margin: 0; padding: 0; background: #000; }
    </style>
</head>
<body>
    <script>
        // MIDI Helper Window - Isolated MIDI operations
        let midiAccess = null;
        let isInitializing = false;

        // Safe postMessage to parent
        function sendToParent(message) {
            if (window.opener) {
                try {
                    window.opener.postMessage(message, '*');
                } catch (error) {
                    console.error('MIDI Helper: Failed to send message to parent:', error);
                }
            }
        }

        // Initialize MIDI (can block this window without affecting main UI)
        async function initializeMIDI() {
            if (isInitializing || midiAccess) return;
            
            isInitializing = true;
            console.log('ðŸŽµ MIDI Helper: Starting initialization...');

            try {
                // This call can block for 15+ seconds, but only affects this helper window
                midiAccess = await navigator.requestMIDIAccess({ sysex: false });
                console.log('ðŸŽµ MIDI Helper: MIDI access granted');

                // Set up device change listener
                midiAccess.onstatechange = (event) => {
                    console.log('ðŸŽµ MIDI Helper: Device state changed:', event.port?.name, event.port?.state);
                    sendDeviceList();
                };

                sendToParent({ type: 'midi:ready' });
                sendDeviceList();

            } catch (error) {
                console.error('ðŸŽµ MIDI Helper: MIDI initialization failed:', error);
                sendToParent({ 
                    type: 'midi:error', 
                    error: error.message || 'MIDI initialization failed' 
                });
            } finally {
                isInitializing = false;
            }
        }

        // Send current device list to parent
        function sendDeviceList() {
            if (!midiAccess) return;

            const devices = [];
            Array.from(midiAccess.outputs.values()).forEach((output) => {
                devices.push({
                    id: output.id,
                    name: output.name || 'Unknown MIDI Device',
                    state: output.state
                });
            });

            console.log(`ðŸŽµ MIDI Helper: Sending ${devices.length} devices to parent`);
            sendToParent({ 
                type: 'midi:devices', 
                devices 
            });
        }

        // Send MIDI command
        function sendMIDICommand(deviceId, command) {
            if (!midiAccess) {
                sendToParent({ 
                    type: 'midi:send_result', 
                    success: false, 
                    error: 'MIDI not initialized' 
                });
                return;
            }

            try {
                // Parse bracket format like [[PC:1:1]]
                const match = command.match(/\[\[(\w+):(\d+):(\d+)\]\]/);
                if (!match) {
                    sendToParent({ 
                        type: 'midi:send_result', 
                        success: false, 
                        error: 'Invalid command format' 
                    });
                    return;
                }

                const [, type, value, channel] = match;
                const channelNum = Math.max(0, Math.min(15, parseInt(channel) - 1));
                
                let midiBytes = [];
                switch (type.toUpperCase()) {
                    case 'PC': // Program Change
                        midiBytes = [0xC0 + channelNum, parseInt(value)];
                        break;
                    case 'CC': // Control Change
                        midiBytes = [0xB0 + channelNum, parseInt(value), 127];
                        break;
                    case 'NOTE': // Note On
                        midiBytes = [0x90 + channelNum, parseInt(value), 127];
                        break;
                    default:
                        sendToParent({ 
                            type: 'midi:send_result', 
                            success: false, 
                            error: `Unsupported command type: ${type}` 
                        });
                        return;
                }

                // Find and send to device
                const output = Array.from(midiAccess.outputs.values()).find(o => o.id === deviceId);
                if (!output || output.state !== 'connected') {
                    sendToParent({ 
                        type: 'midi:send_result', 
                        success: false, 
                        error: 'Device not found or not connected' 
                    });
                    return;
                }

                output.send(new Uint8Array(midiBytes));
                console.log(`ðŸŽµ MIDI Helper: Sent command to ${output.name}: ${command}`);
                sendToParent({ 
                    type: 'midi:send_result', 
                    success: true, 
                    device: output.name 
                });

            } catch (error) {
                console.error('ðŸŽµ MIDI Helper: Send command failed:', error);
                sendToParent({ 
                    type: 'midi:send_result', 
                    success: false, 
                    error: error.message 
                });
            }
        }

        // Listen for messages from parent
        window.addEventListener('message', (event) => {
            // Accept from any origin for now, but verify message structure
            if (!event.data || typeof event.data !== 'object') return;

            const { type, ...payload } = event.data;
            console.log('ðŸŽµ MIDI Helper: Received message:', type, payload);

            switch (type) {
                case 'midi:init':
                    initializeMIDI();
                    break;
                    
                case 'midi:refresh':
                    if (midiAccess) {
                        sendDeviceList();
                    } else {
                        initializeMIDI();
                    }
                    break;
                    
                case 'midi:send':
                    sendMIDICommand(payload.deviceId, payload.command);
                    break;
                    
                default:
                    console.log('ðŸŽµ MIDI Helper: Unknown message type:', type);
            }
        });

        // Signal ready state
        console.log('ðŸŽµ MIDI Helper: Helper window ready');
        sendToParent({ type: 'midi:helper_ready' });
    </script>
</body>
</html>