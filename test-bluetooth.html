<!DOCTYPE html>
<html>
<head>
    <title>Bluetooth MIDI Test</title>
</head>
<body>
    <h1>Simple Bluetooth MIDI Test</h1>
    <button onclick="testConnection()">Test Connection</button>
    <div id="output"></div>
    
    <script>
    let device = null;
    let characteristic = null;
    
    async function testConnection() {
        const output = document.getElementById('output');
        output.innerHTML = '';
        
        try {
            console.log('üîç Starting Bluetooth scan...');
            device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [
                    '03b80e5a-ede8-4b33-a751-6ce34ec4c700', // Standard MIDI
                    '7772e5db-3868-4112-a1a9-f2669d106bf3', // Roland
                    '6e400001-b5a3-f393-e0a9-e50e24dcca9e'  // Nordic UART
                ]
            });
            
            output.innerHTML += `<p>‚úÖ Device selected: ${device.name}</p>`;
            console.log('‚úÖ Device:', device);
            
            const server = await device.gatt.connect();
            output.innerHTML += `<p>‚úÖ Connected to GATT server</p>`;
            
            // Try each service
            const services = await server.getPrimaryServices();
            output.innerHTML += `<p>üìã Found ${services.length} services</p>`;
            
            for (const service of services) {
                output.innerHTML += `<p>Service: ${service.uuid}</p>`;
                
                const characteristics = await service.getCharacteristics();
                for (const char of characteristics) {
                    const props = char.properties;
                    output.innerHTML += `<p>  Char ${char.uuid}: write=${props.write}, writeWR=${props.writeWithoutResponse}</p>`;
                    
                    if (props.write || props.writeWithoutResponse) {
                        characteristic = char;
                        output.innerHTML += `<p>‚úÖ Using characteristic for MIDI</p>`;
                        
                        // Test sending MIDI
                        await testMidiSend();
                        break;
                    }
                }
                if (characteristic) break;
            }
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            output.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
        }
    }
    
    async function testMidiSend() {
        if (!characteristic) return;
        
        try {
            // Test Program Change command
            const midiBytes = new Uint8Array([0xC0, 0x0B]); // PC 12 Channel 1
            const packet = new Uint8Array([0x80, 0x80, ...midiBytes]);
            
            const output = document.getElementById('output');
            output.innerHTML += `<p>üì§ Sending: ${Array.from(packet).map(b => b.toString(16)).join(' ')}</p>`;
            
            if (characteristic.properties.writeWithoutResponse) {
                await characteristic.writeValueWithoutResponse(packet);
                output.innerHTML += `<p>‚úÖ Sent without response</p>`;
            } else if (characteristic.properties.write) {
                await characteristic.writeValueWithResponse(packet);
                output.innerHTML += `<p>‚úÖ Sent with response</p>`;
            }
            
        } catch (error) {
            const output = document.getElementById('output');
            output.innerHTML += `<p>‚ùå Send failed: ${error.message}</p>`;
        }
    }
    </script>
</body>
</html>